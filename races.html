<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Precinct-by-precinct vote totals</title>
  <link rel="icon" type="image/png" href="//projects.statesman.com/common/favicon.ico">

  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>

  <link href="bower_components/bootstrap/dist/css/bootstrap.css" rel="stylesheet">
  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
  <style>
    body {
      font-family: 'Open Sans', sans-serif;
      background: #f9f9f9;
    }
    .navbar {
      background: #395271;
      border-radius: 0;
    }
    .navbar-brand img {
      height: 26px;
      width: auto;
    }
    #legend {
      display: none;
    }
    .legend-item .color {
      border:1px solid;
      opacity: .4;
      width: 12px;
      height: 12px;
      float: left;
      margin-right: 5px;
      border-radius: 50%;
      margin-top: 4px;
    }
    .panel {
      border-radius: 0;
    }
    #key .panel-body {
      padding-bottom: 5px;
    }
    .panel-title {
      font-weight: bold;
      text-transform: uppercase;
      font-size: 0.95em;
      color: #777;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-default" role="navigation">
    <div class="container">
      <div class="navbar-header">
        <a class="navbar-brand" href="#">
          <img width="546" height="52" src="assets/logo.png" />
        </a>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="row">
      <div class="col-xs-12 col-sm-4">
        <div class="form-group">
          <label for="race" class="control-label">Choose a race:</label>
          <select class="form-control" id="race">
            <optgroup label="State offices">
              <option value="governor">Governor</option>
              <option value="lt-governor">Lt. Governor</option>
              <option value="attorney-general">Attorney General</option>
            </optgroup>
            <optgroup label="U.S. Senator">
              <option value="senate">U.S. Senator</option>
            </optgroup>
            <optgroup label="U.S. Representative">
              <option value="us-rep-10" data-center="30.341302420968095,-97.64940643310548">District 10</option>
              <option value="us-rep-17" data-center="30.428375366501577,-97.56906890869142">District 17</option>
              <option value="us-rep-21" data-zoom="1" data-center="30.20550377358846,-97.82930755615236">District 21</option>
              <option value="us-rep-25" data-zoom="-1" data-center="30.38514475827691,-97.94586563110353">District 25</option>
              <option value="us-rep-35" data-center="30.19660211266278,-97.66846084594728">District 35</option>
            </optgroup>
            <optgroup label="State Senate">
              <option value="state-senate-14" data-zoom="-1" data-center="30.348413324166945,-97.75171661376955">District 14</option>
              <option value="state-senate-25" data-zoom="1" data-center="30.1589095005721,-97.85969161987306">District 25</option>
            </optgroup>
            <optgroup label="State Representative">
              <option value="state-house-46" data-zoom="1" data-center="30.35907871018818,-97.61301422119142">District 46</option>
              <option value="state-house-47" data-zoom="-1" data-center="30.336561531832643,-97.95496368408205">District 47</option>
              <option value="state-house-48" data-center="30.282617764815303,-97.81042480468751">District 48</option>
              <option value="state-house-49" data-zoom="1">District 49</option>
              <option value="state-house-50" data-center="30.353746162505935,-97.58005523681642">District 50</option>
              <option value="state-house-51" data-center="30.16039373431057,-97.67412567138673">District 51</option>
            </optgroup>
            <optgroup label="City of Austin races">
              <option value="mayor">Austin Mayor</option>
              <option selected value="rail">Urban rail</option>
              <option value="council-d1" data-center="30.311964485472895,-97.63481521606447">Austin City Council, District 1</option>
              <option value="council-d2" data-zoom="1" data-center="30.17078274487305,-97.65404129028322">Austin City Council, District 2</option>
              <option value="council-d3" data-zoom="1" data-center="30.217668074920706,-97.68991851806642">Austin City Council, District 3</option>
              <option value="council-d4" data-zoom="1" data-center="30.347820768633277,-97.70193481445314">Austin City Council, District 4</option>
              <option value="council-d5" data-zoom="1" data-center="30.171969990649355,-97.80767822265626">Austin City Council, District 5</option>
              <option value="council-d6" data-zoom="1" data-center="30.404393625935764,-97.83583068847658">Austin City Council, District 6</option>
              <option value="council-d7" data-zoom="1" data-center="30.383663919043997,-97.69541168212892">Austin City Council, District 7</option>
              <option value="council-d8" data-zoom="1" data-center="30.243178552369244,-97.85780334472658">Austin City Council, District 8</option>
              <option value="council-d9" data-zoom="2" data-center="30.271944052881455,-97.73489379882814">Austin City Council, District 9</option>
              <option value="council-d10" data-zoom="1" data-center="30.35137604801479,-97.7984085083008">Austin City Council, District 10</option>
            </optgroup>
          </select>
        </div>
        <div id="legend" class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">Legend</h3>
          </div>
          <div class="panel-body"></div>
        </div>
        <div id="key" class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">Precinct <span id="number"></span>results</h3>
          </div>
          <div class="panel-body">
            <p>Hover over a race to see per-precinct vote counts.</p>
          </div>
        </div>
      </div>
      <div class="col-xs-12 col-sm-8">
        <div id="map" style="width:100%;height:700px;"></div>
      </div>
    </div>
  </div>

  <script type="text/javascript" src="bower_components/jquery/dist/jquery.js"></script>
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?key=AIzaSyCy25plOzFlJryxCSF7CkOWL86C8tZWsLI"></script>
  <script type="text/javascript" src="bower_components/gmaps/gmaps.js"></script>
  <script type="text/javascript" src="bower_components/underscore/underscore.js"></script>
  <script type="text/javascript" src="bower_components/tinycolor/tinycolor.js"></script>
  <script type="text/javascript" src="bower_components/handlebars/handlebars.js"></script>

  <script id="legend-template" type="text/x-handlebars-template">
    <table class="table table-striped table-condensed">
      <thead>
        <tr>
          <th>Candidate</th>
          <th class="text-right">Votes</th>
        </tr>
      </thead>
      <tbody>
        {{#each results}}
          <tr>
            <td>{{candidate}}</td>
            <td class="text-right">{{votes}}</td>
          </tr>
        {{/each}}
      </tbody>
    </table>
  </script>

  <script>
  function Palette() {
    this.colors = [
      '#1E8A0E',
      '#336699',
      '#FFCC00',
      '#FF6600',
      '#4D1979'
    ];
    this.partycolors = {
      'REP': '#B72B21',
      'LIB': '#E0C828',
      'DEM': '#3A56E0',
      'GRN': '#1E8A0E'
    };
    this.nextColor = 0;
    this.candidates = {};
    $('#legend').show();
    $('#legend').find('.panel-body').empty();
  }
  Palette.prototype.set = function(candidate, color) {
    this.candidates[candidate] = color;
    $('#legend').find('.panel-body').append("<div class='legend-item'><div class='color' style='background-color:" + color + ";border-color:" + color + ";'></div>" + candidate + "</div></div>");
  };
  Palette.prototype.get = function(candidate, party) {
    if(typeof this.candidates[candidate] === "undefined") {
      if(party === "") {
        this.set(candidate, this.colors[this.nextColor]);
        this.nextColor++;
      }
      else {
        this.set(candidate, this.partycolors[party]);
      }
    }
    return this.candidates[candidate]
  };

  var legend = Handlebars.compile($("#legend-template").html());

  var map;

  var set_race = function(race, map) {
    map.removePolygons();
    map.removePolylines();
    colors = new Palette();

    if(race === 'rail') {
      $.getJSON('race-data/rail.json', function(data) {
        _.each(data.features, function(feature) {
          if(typeof feature.properties !== "undefined") {
            var votes_for = 0;
            var total_votes = 0;
            _.each(feature.properties.races, function(opt) {
              if(opt.candidate === "For") {
                votes_for += opt.votes;
              }
              total_votes += opt.votes;
            });
            map.drawPolygon({
              paths: feature.geometry.coordinates,
              useGeoJSON: true,
              strokeColor: '#fff',
              strokeOpacity: 0.5,
              strokeWeight: 1,
              fillColor: '#3A56E0',
              fillOpacity: (votes_for / total_votes) * 1.25,
              mouseover: function() {
                var data = {
                  precinct: feature.properties.precinct,
                  results: feature.properties.races
                }
                $('#key').find('.panel-body').html(legend(data));
                $('#key').find('#number').text(feature.properties.precinct + ' ');
                $('#key:hidden').show();
              },
              mouseout: function() {
                $('#key').hide();
              }
            });
          }
        });
        $('#legend').find('.panel-body').append("<div class='legend-item'><div class='color' style='background-color:#3A56E0;border-color:#3A56E0;'></div>Votes for rail <small>(darker precincts indicate higher support)</small></div></div>");
        // Draw the proposed rail line
        $.getJSON('rail-routes/new.json', function(data) {
          var rail_line = data.features[0].geometry.coordinates;
          var transposed_coords = _.map(rail_line, function(el) {
            return [el[1], el[0]];
          });
          map.drawPolyline({
            path: transposed_coords,
            strokeColor: '#B72B21',
            strokeOpacity: 0.75,
            strokeWeight: 5,
          });
          $('#legend').find('.panel-body').append("<div class='legend-item'><div class='color' style='background-color:#B72B21;border-color:#B7B21;'></div>Proposed rail line</div></div>");
        });
      });
    }

    else {
      $.getJSON('race-data/' + race + '.json', function(data) {
        _.each(data.features, function(feature) {
          if(typeof feature.properties !== "undefined") {
            var stroke = tinycolor(colors.get(feature.properties.winner.candidate, feature.properties.winner.party));
            var fill = tinycolor(colors.get(feature.properties.winner.candidate, feature.properties.winner.party));

            map.drawPolygon({
              paths: feature.geometry.coordinates,
              useGeoJSON: true,
              strokeColor: '#fff',
              strokeOpacity: 0.5,
              strokeWeight: 1,
              fillColor: fill.toHexString(),
              fillOpacity: 0.5,
              mouseover: function() {
                var data = {
                  precinct: feature.properties.precinct,
                  results: feature.properties.races
                }
                $('#key').find('.panel-body').html(legend(data));
                $('#key').find('#number').text(feature.properties.precinct + ' ');
                $('#key:hidden').show();
              },
              mouseout: function() {
                $('#key').hide();
              }
            });
          }
        });
      });
    }
  };

  $(function() {

    var center_default = [30.280245929155083,-97.73489379882814];
    var zoom_default = 11;

    map = new GMaps({
      div: '#map',
      lat: center_default[0],
      lng: center_default[1],
      zoom: zoom_default
    });
    set_race('rail', map);

    $('#race').change(function() {
      var race = $(this).val();
      if(race === 'none') {
        map.removePolygons();
        map.setCenter(center_default[0], center_default[1]);
        map.setZoom(zoom_default);
      }
      else {
        set_race(race, map);
      }
      var center = $(this).find(':selected').attr('data-center');
      if(typeof center !== "undefined") {
        center = center.split(',');
        map.setCenter(center[0], center[1]);
      }
      else {
        map.setCenter(center_default[0], center_default[1]);
      }
      var zoom = $(this).find(':selected').attr('data-zoom');
      if(typeof zoom !== "undefined") {
        console.log(parseInt(zoom, 10));
        map.setZoom(zoom_default + parseInt(zoom, 10));
      }
      else {
        map.setZoom(zoom_default);
      }
    });

  });
  </script>
</body>
</html>
